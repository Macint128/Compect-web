<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Compect Web IDE</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-title" content="Compect Web IDE" />
<style>
body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
#toolbar { display:flex; gap:5px; padding:5px; background:#222; }
#toolbar button { background:#444; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; }
#toolbar button:hover { background:#666; }
#tabs { display:flex; background:#333; }
#tabs button { flex:1; padding:5px; color:white; background:#333; border:none; cursor:pointer; }
#tabs button.active { background:#555; }
#container { flex:1; display:flex; flex-direction:row; overflow:hidden; }
#editor, #preview, #guide { flex:1; padding:5px; overflow:auto; }
#preview { border-left:1px solid #ccc; background:#f9f9f9; }
#guide { display:none; background:#f0f0f0; color:#000; }
input[type=file] { display:none; }
</style>
</head>
<body>

<div id="toolbar">
    <button onclick="insertSnippet('set')">Set 기본 구조</button>
    <button onclick="insertSnippet('btn')">버튼</button>
    <button onclick="insertSnippet('ios-head')">iOS head</button>
    <button onclick="downloadFile('cw')">.cw 다운로드</button>
    <button onclick="downloadFile('html')">.html 다운로드</button>
    <button onclick="document.getElementById('fileInput').click()">파일 업로드</button>
    <input type="file" id="fileInput" accept=".cw,.txt,.html">
</div>

<div id="tabs">
    <button class="active" onclick="showTab('editor')">Editor</button>
    <button onclick="showTab('preview')">Preview</button>
    <button onclick="showTab('guide')">Guide</button>
</div>

<div id="container">
    <div id="editor" style="width:100%;height:100%;"></div>
    <div id="preview"></div>
    <div id="guide">
<h2>Compect Web 문법 안내서</h2>

<h3>1. 기본 구조</h3>
<pre>
Set(head){ ... }
Set(body){ ... }
let styles = [ *{ ... } ]
</pre>

<h3>2. CSS</h3>
<p>- 배열 안에 직접 CSS 블록 작성 가능</p>

<h3>3. 스크립트</h3>
<pre>
&lt;function greet(){ ... }&gt;
(button ~>[onclick:"greet()"]){ "Click me" }
</pre>

<h3>4. iOS 웹앱</h3>
<pre>
(meta ~>[name:"apple-mobile-web-app-capable", content:"yes"]){ }
(link ~>[rel:"apple-touch-icon", href:"icon.png"]){ }
(meta ~>[name:"apple-mobile-web-app-title", content:"타이틀"]){ }
</pre>
    </div>
</div>

<!-- Monaco Editor -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
<script>
// ---- Compect Web 트랜스파일러 ----
function parseCompect(code){
    let html = "";
    const lines = code.split('\n');
    const stack = [];

    for(let i=0;i<lines.length;i++){
        let line = lines[i].trim();
        if(!line || line.startsWith("//")) continue;

        const mSet = line.match(/^Set\((\w+)\)\{/);
        if(mSet){ html += `<${mSet[1]}>`; stack.push(mSet[1]); continue; }

        if(line === "}"){ if(stack.length) html += `</${stack.pop()}>`; continue; }

        // styles 배열 처리 (그대로 CSS 블록)
        if(line.startsWith("let styles")){
            const cssLines = [];
            i++;
            while(i<lines.length && !lines[i].trim().startsWith("]")){
                cssLines.push(lines[i]);
                i++;
            }
            html += "<style>\n" + cssLines.join("\n") + "\n</style>";
            continue;
        }

        const mScript = line.match(/^<function\s([\s\S]*)>$/);
        if(mScript){ html += `<script>${mScript[1]}</script>`; continue; }

        const mTagAttr = line.match(/^\((\w+)\s*~>\[(.*)\]\)\{(.*)\}$/);
        if(mTagAttr){
            let [_, tag, attrStr, content] = mTagAttr;
            const attrs = attrStr.split(',').map(x=>{
                const [k,v] = x.split(':');
                return `${k.trim()}="${v.trim().replace(/"/g,'')}"`;
            }).join(' ');
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag} ${attrs}>${content}</${tag}>`;
            continue;
        }

        const mTag = line.match(/^\((\w+)\)\{(.*)\}$/);
        if(mTag){
            let [_, tag, content] = mTag;
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag}>${content}</${tag}>`;
            continue;
        }
    }

    return html;
}

// ---- Monaco Editor 초기화 ----
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    monaco.languages.register({ id: 'compectweb' });

    monaco.languages.setMonarchTokensProvider('compectweb', {
        tokenizer: {
            root: [
                [/\b(Set|let|if|function)\b/, "keyword"],
                [/\(\w+\)/, "tag"],
                [/~>\[[^\]]*\]/, "attribute"],
                [/<function.*?>/, "function"],
                [/\*\{[^}]*\}/, "operator"],
                [/".*?"/, "string"],
                [/\{[^}]*\}/, "object"]
            ]
        }
    });

    monaco.editor.defineTheme('cw-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [
            { token: 'keyword', foreground: 'ff79c6', fontStyle: 'bold' },
            { token: 'tag', foreground: '8be9fd' },
            { token: 'attribute', foreground: '50fa7b' },
            { token: 'function', foreground: 'bd93f9' },
            { token: 'operator', foreground: 'f1fa8c' },
            { token: 'string', foreground: 'f1fa8c' },
            { token: 'object', foreground: 'ffb86c' }
        ]
    });

    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: 'Set(body){\n    (div){ "Hello Compect Web!" }\n}',
        language: 'compectweb',
        theme: 'cw-dark',
        automaticLayout: true
    });

    editor.onDidChangeModelContent(() => {
        document.getElementById('preview').innerHTML = parseCompect(editor.getValue());
        attachInlineScripts();
    });
});

// ---- inline onclick 실행 ----
function attachInlineScripts(){
    const previewDiv = document.getElementById('preview');
    const buttons = previewDiv.querySelectorAll('[onclick]');
    buttons.forEach(btn => {
        const fnStr = btn.getAttribute('onclick');
        try { btn.onclick = new Function(fnStr); } 
        catch(e){ console.error(e); }
    });
}

// ---- Snippets ----
const snippetTemplates = {
    "set": `Set(basic){
    Set(head){
        {lang:en}
        {title:"Page Title"}
        let styles = [
            *{ box-sizing:border-box }
        ]
    }
    Set(body){
        (div){ "Content here" }
    }
}`,
    "btn": `(button ~>[onclick:"greet()"]){ "Click me" }`,
    "ios-head": `Set(head){
    {lang:en}
    {title:"Compect Web Page"}
    (meta ~>[charset:"UTF-8"]){ }
    (meta ~>[name:"viewport", content:"width=device-width, initial-scale=1, user-scalable=no"]){ }
    (meta ~>[name:"apple-mobile-web-app-capable", content:"yes"]){ }
    (meta ~>[name:"apple-mobile-web-app-status-bar-style", content:"black-translucent"]){ }
    (link ~>[rel:"apple-touch-icon", href:"icon.png"]){ }
    (meta ~>[name:"apple-mobile-web-app-title", content:"Compect Web Page"]){ }
}`
};

function insertSnippet(key){
    const sel = editor.getSelection();
    editor.executeEdits("", [{
        range: sel,
        text: snippetTemplates[key]
    }]);
}

// ---- 파일 다운로드 ----
function downloadFile(type){
    let content = "";
    if(type==="cw") content = editor.getValue();
    else content = parseCompect(editor.getValue());
    const blob = new Blob([content], {type:'text/plain'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `page.${type}`;
    a.click();
}

// ---- 파일 업로드 ----
document.getElementById('fileInput').addEventListener('change', e=>{
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(evt){
        editor.setValue(evt.target.result);
    }
    reader.readAsText(file);
});

// ---- 탭 전환 ----
function showTab(tab){
    document.getElementById('editor').style.display = tab==='editor'?'block':'none';
    document.getElementById('preview').style.display = tab==='preview'?'block':'none';
    document.getElementById('guide').style.display = tab==='guide'?'block':'none';
    document.querySelectorAll('#tabs button').forEach(btn=>btn.classList.remove('active'));
    document.querySelector(`#tabs button[onclick*="${tab}"]`).classList.add('active');
}
</script>
</body>
</html>