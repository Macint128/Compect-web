<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Compect Web IDE</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-title" content="Compect Web IDE" />

<style>
    body{margin:0;font-family:sans-serif;display:flex;flex-direction:column;height:100vh;background:#1e1e1e;color:#fff}
    #toolbar{display:flex;gap:5px;padding:6px;background:#252526;box-shadow:0 2px 4px rgba(0,0,0,0.5)}
    #toolbar button{background:#007acc;color:white;border:none;padding:6px 12px;border-radius:4px;font-weight:bold;cursor:pointer;transition:.2s}
    #toolbar button:hover{background:#3399ff}
    #tabs{display:flex;background:#333}
    #tabs button{flex:1;padding:8px;color:white;background:#333;border:none;cursor:pointer;transition:.2s}
    #tabs button.active{background:#007acc}
    #container{flex:1;display:flex;flex-direction:row;overflow:hidden}
    #editor,#preview,#guide{flex:1;padding:5px;overflow:auto}
    #preview{border-left:1px solid #444;background:#1e1e1e}
    #guide{display:none;background:#2a2a2a;color:#eee;padding:10px}
    @media(max-width:800px){#container{flex-direction:column}#preview{border-left:none;border-top:1px solid #444;height:50%}}
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="insertSnippet('set')">Set 기본</button>
  <button onclick="insertSnippet('btn')">버튼</button>
  <button onclick="downloadFile('cw')">.cw 다운로드</button>
  <button onclick="downloadFile('html')">.html 다운로드</button>
  <button onclick="document.getElementById('fileInput').click()">파일 업로드</button>
  <input type="file" id="fileInput" accept=".cw,.txt,.html" style="display:none" onchange="handleFile(event)">
</div>

<div id="tabs">
  <button class="active" onclick="showTab('editor')">Editor</button>
  <button onclick="showTab('preview')">Preview</button>
  <button onclick="showTab('guide')">Guide</button>
</div>

<div id="container">
  <div id="editor"></div>
  <div id="preview"></div>
  <div id="guide">
    <h2>Compect Web 문법 안내서</h2>
    <p>Set, let styles, &lt;function&gt;, (div), (button) 등 문법 사용법</p>
    <p>CSS는 let styles = [ ... ] 안에 블록 그대로 작성</p>
    <p>JS는 &lt;function name(){ ... }&gt;로 작성</p>
    <p>HTML 구조는 (태그){ 내용 } 형식</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    monaco.languages.register({ id: 'compectweb' });
    monaco.languages.setMonarchTokensProvider('compectweb', {
        tokenizer: { root: [
            [/\bSet\(/, "keyword"],
            [/\blet\b/, "keyword"],
            [/\bfunction\b/, "keyword"],
            [/\*{/, "operator"],
            [/\(.*\)/, "tag"],
            [/".*?"/, "string"]
        ]}
    });
    monaco.languages.registerCompletionItemProvider('compectweb', {
        provideCompletionItems: () => ({
            suggestions:[
                { label:'Set(head){', kind:monaco.languages.CompletionItemKind.Keyword, insertText:'Set(head){' },
                { label:'Set(body){', kind:monaco.languages.CompletionItemKind.Keyword, insertText:'Set(body){' },
                { label:'let styles = [*{ ... }]', kind:monaco.languages.CompletionItemKind.Snippet, insertText:'let styles = [\n  *{\n  }\n]' },
                { label:'(div){ ... }', kind:monaco.languages.CompletionItemKind.Snippet, insertText:'(div){ "$1" }' },
                { label:'<function name(){...}>', kind:monaco.languages.CompletionItemKind.Snippet, insertText:'<function $1(){\n\n}>' }
            ]
        })
    });

    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value:'Set(body){\n  (div){ "Hello Compect Web!" }\n}',
        language:'compectweb',
        theme:'vs-dark',
        automaticLayout:true
    });

    editor.onDidChangeModelContent(()=>{updatePreview()});
});

function updatePreview(){
    const code = editor.getValue();
    document.getElementById('preview').innerHTML = parseCompect(code);
}

function parseCompect(code){
    // 간단한 변환기: let styles → <style>, (태그){...} → <태그>...</태그>, <function> 무시
    let html = '';
    const lines = code.split('\n');
    let inStyles = false;
    for(let line of lines){
        line = line.trim();
        if(line.startsWith('let styles')){ inStyles=true; html+='<style>'; continue;}
        if(inStyles){
            if(line.startsWith(']')){ inStyles=false; html+='</style>'; continue; }
            html+=line+'\n';
            continue;
        }
        let match = line.match(/^\((\w+)(?: ~>\[([^\]]+)\])?\)\{(.*)\}$/);
        if(match){
            const tag = match[1];
            const attrs = match[2]? match[2].split(',').map(a=>a.split(':')).map(([k,v])=>`${k.trim()}="${v.trim().replace(/^"|"$/g,'')}"`).join(' '):'';
            const content = match[3].trim();
            html+=`<${tag} ${attrs}>${content}</${tag}>`;
        }
    }
    return html;
}

function insertSnippet(type){
    if(type==='set') editor.trigger('keyboard','type',{text:'Set(body){\n  (div){ "Hello" }\n}'});
    if(type==='btn') editor.trigger('keyboard','type',{text:'(button){ "Click" }'});
}

function downloadFile(ext){
    let filename = ext==='cw'?'code.cw':'code.html';
    let blob;
    if(ext==='cw'){ blob=new Blob([editor.getValue()],{type:'text/plain'});}
    else{ blob=new Blob([parseCompect(editor.getValue())],{type:'text/html'});}
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob);
    link.download=filename; link.click();
}

function showTab(tab){
    document.getElementById('editor').style.display=tab==='editor'?'block':'none';
    document.getElementById('preview').style.display=tab==='preview'?'block':'none';
    document.getElementById('guide').style.display=tab==='guide'?'block':'none';
    document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`#tabs button:nth-child(${tab==='editor'?1:tab==='preview'?2:3})`).classList.add('active');
}

function handleFile(event){
    const file=event.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{editor.setValue(e.target.result);};
    reader.readAsText(file);
}
</script>
</body>
</html>
