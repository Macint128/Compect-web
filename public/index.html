<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Compect Web IDE</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-title" content="Compect Web IDE" />
<style>
body {
    margin: 0;
    font-family: sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #111;
    color: #fff;
    border-radius: 30px;
}

#toolbar {
    display: flex;
    gap: 5px;
    padding: 8px;
    background: #222;
    border-radius: 30px;
    align-items: center;
}

#toolbar button {
    background: #444;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
}

#toolbar button:hover { background: #666; }

#tabs {
    display: flex;
    background: #333;
    border-radius: 30px;
    overflow: hidden;
}

#tabs button {
    flex: 1;
    padding: 8px;
    color: white;
    background: #333;
    border: none;
    cursor: pointer;
    border-radius: 20px;
}

#tabs button.active { background: #555; }

#container {
    position: relative;
    flex: 1;
    overflow: hidden;
}

#editor, #preview, #guide {
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    padding: 10px;
    overflow: auto;
    border-radius: 20px;
    background-clip: padding-box;
}

#editor { background: #1e1e1e; color: #fff; z-index: 3; }
#preview, #guide { display: none; background: #f9f9f9; color: #000; z-index: 2; }

input[type="file"] { display: none; }
.monaco-editor { border-radius: 20px !important; overflow: hidden; }
</style>
</head>
<body>
<div id="toolbar">
    <button onclick="insertSnippet('set')">Set 기본 구조</button>
    <button onclick="insertSnippet('btn')">버튼</button>
    <button onclick="downloadFile('cw')">.cw 다운로드</button>
    <button onclick="downloadFile('html')">.html 다운로드</button>
    <button onclick="document.getElementById('fileInput').click()">파일 업로드</button>
    <input type="file" id="fileInput" accept=".cw,.txt,.html">
</div>

<div id="tabs">
    <button class="active" onclick="showTab('editor')">Editor</button>
    <button onclick="showTab('preview')">Preview</button>
    <button onclick="showTab('guide')">Guide</button>
</div>

<div id="container">
    <div id="editor"></div>
    <div id="preview"></div>
    <div id="guide">
        <h2>Compect Web 문법 안내서</h2>
        <pre>
Set(basic){
    Set(head){
        {lang:en}
        {title:"Page Title"}
        let styles = [
            *{ box-sizing:border-box }
        ]
        let script = [
            function greet(){ ... }
        ]
    }
    Set(body){
        (div){ "Content here" }
    }
}
        </pre>
        <p>* CSS는 let styles 배열에, JS는 let script 배열에 넣어야 함</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
<script>
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    monaco.languages.register({ id: 'compectweb' });
    monaco.languages.setMonarchTokensProvider('compectweb', {
        tokenizer: { root: [
            [/\bSet\(/, "keyword"],
            [/\b(let|if|else|for|while)\b/, "keyword"],
            [/\bfunction\b/, "keyword"],
            [/\*{/, "operator"],
            [/\{.*\}/, "attribute"],
            [/\(.*\)/, "tag"],
            [/".*?"/, "string"]
        ]}
    });
    monaco.languages.registerCompletionItemProvider('compectweb', {
        provideCompletionItems: () => {
            return { suggestions: [
                { label: 'Set(head){', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'Set(head){' },
                { label: 'Set(body){', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'Set(body){' },
                { label: 'let styles = [*{ ... }]', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'let styles = [\n\t*{\n\t\t\n\t}\n]' },
                { label: 'let script = [function ...]', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'let script = [\n\tfunction $1(){\n\t\t\n\t}\n]' },
                { label: '(div){ ... }', kind: monaco.languages.CompletionItemKind.Snippet, insertText: '(div){ "$1" }' }
            ]};
        }
    });

    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: [
            'Set(head){',
            '    {lang:en}',
            '    {title:"Compect Web Sample"}',
            '    let styles = [',
            'body { display:flex; align-items:center; justify-content:center; height:100vh; background:#111; color:#fff; }',
            '    ]',
            '    let script = [',
            'function greet(){ alert("Hello!"); }',
            '    ]',
            '}',
            '',
            'Set(body){',
            '    (div){ "Hello Compect Web!" }',
            '}'
        ].join('\n'),
        language: 'compectweb',
        theme: 'vs-dark',
        automaticLayout: true
    });

    function showTab(id){
        ['editor','preview','guide'].forEach(x=>{
            document.getElementById(x).style.display = (x===id)?'block':'none';
        });
        document.querySelectorAll('#tabs button').forEach(b=>{
            b.classList.toggle('active', b.textContent.toLowerCase()===id);
        });
    }
    showTab('editor');

    function insertSnippet(name){
        const templates = {
            "set": 'Set(basic){\n\tSet(head){\n\t\t{lang:en}\n\t\t{title:"Page Title"}\n\t\tlet styles = [\n\t\t\t*{ box-sizing:border-box }\n\t\t]\n\t\tlet script = [\n\t\t\tfunction greet(){ alert("Hello!"); }\n\t\t]\n\t}\n\tSet(body){\n\t\t(div){ "Content here" }\n\t}\n}',
            "btn": '(button ~>[onclick:"greet()"]){ "Click me" }'
        };
        const snippet = templates[name] || '';
        const model = editor.getModel();
        const pos = editor.getPosition();
        model.applyEdits([{ range: new monaco.Range(pos.lineNumber,pos.column,pos.lineNumber,pos.column), text: snippet }]);
    }

    function parseCompect(code){
        var html = '';
        var styleMatch = code.match(/let styles = \[([\s\S]*?)\]/);
        if(styleMatch) html += '<style>' + styleMatch[1] + '</style>\n';

        var scriptMatch = code.match(/let script = \[([\s\S]*?)\]/);
        if(scriptMatch) html += '<script>' + scriptMatch[1] + '<\/script>\n';

        var bodyMatch = code.match(/Set\(body\)\{([\s\S]*?)\}/);
        if(bodyMatch) html += bodyMatch[1] + '\n';

        return html;
    }

    function updatePreview(){
        var html = parseCompect(editor.getValue());
        var preview = document.getElementById('preview');
        preview.innerHTML = html;
    }

    editor.onDidChangeModelContent(()=>updatePreview());
    updatePreview();

    function downloadFile(type){
        var content='', filename='';
        if(type==='cw'){
            content = editor.getValue();
            filename='page.cw';
        } else {
            content = '<!DOCTYPE html>\n<html>\n'+parseCompect(editor.getValue())+'</html>';
            filename='page.html';
        }
        var a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([content],{type:'text/plain'}));
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    document.getElementById('fileInput').addEventListener('change', function(e){
        var f = e.target.files[0];
        if(!f) return;
        var reader = new FileReader();
        reader.onload = function(ev){
            editor.setValue(ev.target.result);
        };
        reader.readAsText(f);
    });

});
</script>
</body>
</html>
