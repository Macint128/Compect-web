<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Compect Web Live IDE</title>
<style>
body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
#toolbar { display:flex; gap:5px; padding:5px; background:#222; }
#toolbar button { background:#444; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; }
#toolbar button:hover { background:#666; }
#container { flex:1; display:flex; flex-direction:row; }
#editor { flex:1; border-right:1px solid #ccc; padding:5px; background:#1e1e1e; color:white; font-family:monospace; overflow:auto; white-space:pre; }
#preview { flex:1; overflow:auto; padding:10px; background:#f9f9f9; }
</style>
</head>
<body>

<div id="toolbar">
    <button onclick="insertSnippet('set')">Set 기본 구조</button>
    <button onclick="insertSnippet('btn')">버튼</button>
    <button onclick="downloadFile('cw')">.cw 다운로드</button>
    <button onclick="downloadFile('html')">.html 다운로드</button>
</div>

<div id="container">
    <div id="editor" contenteditable="true">
Set(body){
    (div){ "Hello Compect Web!" }
}
    </div>
    <div id="preview"></div>
</div>

<script>
// ---- Compect Web 트랜스파일러 ----
function parseCompect(code){
    let html = "";
    const stack = [];
    const lines = code.split('\n');

    for (let line of lines){
        line = line.trim();
        if(!line || line.startsWith("//")) continue;

        const mSet = line.match(/^Set\((\w+)\)\{/);
        if(mSet){ html += `<${mSet[1]}>`; stack.push(mSet[1]); continue; }

        if(line === "}"){ if(stack.length) html += `</${stack.pop()}>`; continue; }

        if(line.startsWith("let styles")){
            const cssMatch = line.match(/\[\s*(.*)\s*\]/s);
            if(cssMatch) html += `<style>${cssMatch[1]}</style>`;
            continue;
        }

        const mScript = line.match(/^<(.*)>$/);
        if(mScript){ html += `<script>${mScript[1]}<\/script>`; continue; }

        const mTagAttr = line.match(/^\((\w+)\s*~>\[(.*)\]\)\{(.*)\}$/);
        if(mTagAttr){
            let [_, tag, attrStr, content] = mTagAttr;
            const attrs = attrStr.split(',').map(x=>{
                const [k,v] = x.split(':');
                return `${k.trim()}="${v.trim().replace(/"/g,'')}"`;
            }).join(' ');
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag} ${attrs}>${content}</${tag}>`;
            continue;
        }

        const mTag = line.match(/^\((\w+)\)\{(.*)\}$/);
        if(mTag){
            let [_, tag, content] = mTag;
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag}>${content}</${tag}>`;
            continue;
        }
    }

    return html;
}

// ---- 실시간 미리보기 ----
const editorDiv = document.getElementById('editor');
const previewDiv = document.getElementById('preview');

function updatePreview(){
    const code = editorDiv.innerText;
    previewDiv.innerHTML = parseCompect(code);
}

editorDiv.addEventListener('input', updatePreview);
updatePreview();

// ---- Snippets ----
const snippetTemplates = {
    "set": `Set(basic){
    Set(head){
        {lang:en}
        {title:"Page Title"}
        let styles = [
            *{ box-sizing:border-box }
        ]
    }
    Set(body){
        (div){ "Content here" }
    }
}`,
    "btn": `(button ~>[onclick:"greet()"]){ "Click me" }`
};

function insertSnippet(name){
    const snippet = snippetTemplates[name] || '';
    editorDiv.innerText += "\n" + snippet;
    updatePreview();
}

// ---- 파일 다운로드 ----
function downloadFile(type){
    let content, filename, mime;
    const code = editorDiv.innerText;

    if(type === 'cw'){
        content = code;
        filename = 'page.cw';
        mime = 'application/octet-stream'; // 확장자 그대로 다운로드
    } else if(type === 'html'){
        content = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Compect Web Page</title>\n</head>\n<body>\n' +
                  parseCompect(code) + '\n</body>\n</html>';
        filename = 'page.html';
        mime = 'text/html';
    } else { return; }

    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>