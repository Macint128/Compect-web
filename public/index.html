<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Compect Web IDE</title>
<link rel="apple-touch-icon" href="icon.png" />
<meta name="apple-mobile-web-app-title" content="Compect Web IDE" />
<style>
body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
#toolbar { display:flex; gap:5px; padding:5px; background:#222; }
#toolbar button { background:#444; color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; }
#toolbar button:hover { background:#666; }
#tabs { display:flex; background:#333; }
#tabs button { flex:1; padding:5px; color:white; background:#333; border:none; cursor:pointer; }
#tabs button.active { background:#555; }
#container { flex:1; display:flex; flex-direction:row; overflow:hidden; }
#editor, #preview, #guide { flex:1; padding:5px; overflow:auto; }
#preview { border-left:1px solid #ccc; background:#f9f9f9; }
#guide { display:none; background:#f0f0f0; color:#000; }
input[type=file] { display:none; }
</style>
</head>
<body>

<div id="toolbar">
    <button onclick="insertSnippet('set')">Set 기본 구조</button>
    <button onclick="insertSnippet('btn')">버튼</button>
    <button onclick="downloadFile('cw')">.cw 다운로드</button>
    <button onclick="downloadFile('html')">.html 다운로드</button>
    <button onclick="document.getElementById('fileInput').click()">파일 업로드</button>
    <input type="file" id="fileInput" accept=".cw,.txt,.html">
</div>

<div id="tabs">
    <button class="active" onclick="showTab('editor')">Editor</button>
    <button onclick="showTab('preview')">Preview</button>
    <button onclick="showTab('guide')">Guide</button>
</div>

<div id="container">
    <div id="editor" style="width:100%;height:100%;"></div>
    <div id="preview"></div>
    <div id="guide">
<h2>Compect Web 문법 안내서 (업데이트)</h2>

<h3>1. 기본 구조</h3>
<pre>
Set(basic){
    Set(head){
        {lang:en}            // HTML lang
        {title:"Page Title"} // 페이지 제목
        let styles = [       // CSS 스타일
            *{ box-sizing:border-box } // 모든 요소에 적용
        ]
    }
    Set(body){
        (div){ "Content here" } // 본문 내용
    }
}
</pre>

<h3>2. 스타일(let styles) 사용</h3>
<p>- <code>let styles = [ ... ]</code> → <code>&lt;style&gt; ... &lt;/style&gt;</code> 로 변환</p>
<p>- <code>*{ ... }</code> → HTML의 모든 요소에 적용 (CSS 전체 선택자)</p>

<h3>3. 변수 / 비교 / 딕셔너리</h3>
<pre>
let x = 10
if x == 10
{ key1: value1, key2: value2 }
</pre>

<h3>4. 스크립트 사용</h3>
<pre>
&lt;function greet(){
    alert("Hello!");
}&gt;
(button ~>[onclick:"greet()"]){ "Click me" }
</pre>

<h3>5. Snippets</h3>
<pre>
- Set 기본 구조
- 버튼
- 스타일: let styles = [ *{ ... } ]
</pre>

<h3>6. 파일 확장자</h3>
<pre>
.cw  -> Compect Web 코드
.html -> 브라우저에서 실행 가능한 HTML
</pre>
    </div>
</div>

<!-- Monaco Editor -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs/loader.js"></script>
<script>
// ---- Compect Web 트랜스파일러 ----
function parseCompect(code){
    let html = "";
    const stack = [];
    const lines = code.split('\n');

    for (let line of lines){
        line = line.trim();
        if(!line || line.startsWith("//")) continue;

        const mSet = line.match(/^Set\((\w+)\)\{/);
        if(mSet){ html += `<${mSet[1]}>`; stack.push(mSet[1]); continue; }

        if(line === "}"){ if(stack.length) html += `</${stack.pop()}>`; continue; }

        if(line.startsWith("let styles")){
            const cssMatch = line.match(/\[\s*(.*)\s*\]/s);
            if(cssMatch) html += `<style>${cssMatch[1]}</style>`;
            continue;
        }

        const mScript = line.match(/^<(.*)>$/);
        if(mScript){ html += `<script>${mScript[1]}<\/script>`; continue; }

        const mTagAttr = line.match(/^\((\w+)\s*~>\[(.*)\]\)\{(.*)\}$/);
        if(mTagAttr){
            let [_, tag, attrStr, content] = mTagAttr;
            const attrs = attrStr.split(',').map(x=>{
                const [k,v] = x.split(':');
                return `${k.trim()}="${v.trim().replace(/"/g,'')}"`;
            }).join(' ');
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag} ${attrs}>${content}</${tag}>`;
            continue;
        }

        const mTag = line.match(/^\((\w+)\)\{(.*)\}$/);
        if(mTag){
            let [_, tag, content] = mTag;
            content = content.trim().replace(/^"|"$/g,'');
            html += `<${tag}>${content}</${tag}>`;
            continue;
        }
    }

    return html;
}

// ---- Monaco Editor 초기화 ----
require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.41.0/min/vs' }});
require(['vs/editor/editor.main'], function() {
    monaco.languages.register({ id: 'compectweb' });

    monaco.languages.setMonarchTokensProvider('compectweb', {
        tokenizer: {
            root: [
                [/\bSet\(/, "keyword"],
                [/\b(let|if)\b/, "keyword"],
                [/\bfunction\b/, "keyword"],
                [/\*{/, "operator"],
                [/\{.*\}/, "attribute"],
                [/\(.*\)/, "tag"],
                [/".*?"/, "string"],
            ]
        }
    });

    monaco.languages.registerCompletionItemProvider('compectweb', {
        provideCompletionItems: () => {
            const suggestions = [
                { label: 'Set(head){', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'Set(head){' },
                { label: 'Set(body){', kind: monaco.languages.CompletionItemKind.Keyword, insertText: 'Set(body){' },
                { label: 'let styles = [*{ ... }]', kind: monaco.languages.CompletionItemKind.Snippet, insertText: 'let styles = [\n\t*{\n\t\t\n\t}\n]' },
                { label: '(div){ ... }', kind: monaco.languages.CompletionItemKind.Snippet, insertText: '(div){ "$1" }' },
                { label: '<function name(){...}>', kind: monaco.languages.CompletionItemKind.Snippet, insertText: '<function $1(){\n\t\n}>' }
            ];
            return { suggestions: suggestions };
        }
    });

    window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: 'Set(body){\n    (div){ "Hello Compect Web!" }\n}',
        language: 'compectweb',
        theme: 'vs-dark',
        automaticLayout: true
    });

    editor.onDidChangeModelContent(() => {
        const code = editor.getValue();
        document.getElementById('preview').innerHTML = parseCompect(code);
        attachInlineScripts();
    });
});

// ---- inline onclick 실행 ----
function attachInlineScripts(){
    const previewDiv = document.getElementById('preview');
    const buttons = previewDiv.querySelectorAll('[onclick]');
    buttons.forEach(btn => {
        const fnStr = btn.getAttribute('onclick');
        try { btn.onclick = new Function(fnStr); } 
        catch(e){ console.error(e); }
    });
}

// ---- Snippets ----
const snippetTemplates = {
    "set": `Set(basic){
    Set(head){
        {lang:en}
        {title:"Page Title"}
        let styles = [
            *{ box-sizing:border-box }
        ]
    }
    Set(body){
        (div){ "Content here" }
    }
}`,
    "btn": `(button ~>[onclick:"greet()"]){ "Click me" }`
};

function insertSnippet(name){
    const snippet = snippetTemplates[name] || '';
    const model = editor.getModel();
    const pos = editor.getPosition();
    model.applyEdits([{
        range: new monaco.Range(pos.lineNumber,pos.column,pos.lineNumber,pos.column),
        text: snippet
    }]);
}

// ---- 파일 다운로드 ----
function downloadFile(type){
    let content, filename, mime;
    const code = editor.getValue();

    if(type === 'cw'){
        content = code;
        filename = 'page.cw';
        mime = 'application/octet-stream';
    } else if(type === 'html'){
        content = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8">\n<title>Compect Web Page</title>\n</head>\n<body>\n' +
                  parseCompect(code) + '\n</body>\n</html>';
        filename = 'page.html';
        mime = 'text/html';
    } else { return; }

    const blob = new Blob([content], {type: mime});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ---- 파일 업로드 ----
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(ev){
        let content = ev.target.result;

        if(file.name.endsWith('.cw') || file.name.endsWith('.txt')){
            editor.setValue(content);
        } else if(file.name.endsWith('.html')){
            const parser = new DOMParser();
            const doc = parser.parseFromString(content, 'text/html');
            editor.setValue(htmlToCompect(doc));
        }
    };
    reader.readAsText(file);
});

// ---- HTML → Compect Web 변환 ----
function htmlToCompect(doc){
    let cw = "";

    // 스타일
    const styles = doc.querySelectorAll('style');
    if(styles.length){
        cw += "let styles = [\n";
        styles.forEach(s => { cw += s.textContent.trim() + "\n"; });
        cw += "]\n\n";
    }

    // 스크립트
    const scripts = doc.querySelectorAll('script');
    scripts.forEach(s => { cw += `<${s.textContent.trim()}>\n`; });

    // body
    const body = doc.body;
    if(body){
        cw += "Set(body){\n";
        body.childNodes.forEach(node => { cw += nodeToCw(node) + "\n"; });
        cw += "}\n";
    }

    return cw;
}

// 단순 태그 → Compect Web
function nodeToCw(node){
    if(node.nodeType === 3) return `"${node.textContent.trim()}"`;
    if(node.nodeType !== 1) return "";

    const tag = node.tagName.toLowerCase();
    const attrs = [];
    for(let i=0;i<node.attributes.length;i++){
        const a = node.attributes[i];
        attrs.push(`${a.name}:"${a.value}"`);
    }
    const attrStr = attrs.length ? ` ~>[${attrs.join(", ")}]` : "";
    const children = Array.from(node.childNodes).map(nodeToCw).join(" ");
    return `(${tag}${attrStr}){ ${children} }`;
}

// ---- 탭 기능 ----
function showTab(tab){
    document.getElementById('editor').style.display = tab==='editor' ? 'block':'none';
    document.getElementById('preview').style.display = tab==='preview' ? 'block':'none';
    document.getElementById('guide').style.display = tab==='guide' ? 'block':'none';
    document.querySelectorAll('#tabs button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`#tabs button[onclick="showTab('${tab}')"]`).classList.add('active');
}
</script>
</body>
</html>